{% extends "./base_earthchie.html"%}

{% block title %} RiskOCA | Upload {% endblock %}

{% block content %}
<style>
  #checkboxYes {
    display: none; 
    border-color: #198754;
    color: #198754;
  }
  #checkboxYes:hover {
    background-color: #198754;
    color: rgb(255, 255, 255);
  }
</style>

<h2 class="text-center"> ระบบปัญญาประดิษฐ์ที่ช่วยในการค้นหาและวิเคราะห์รอยโรคก่อนมะเร็งและมะเร็งช่องปาก</h2>
<h4 class="text-center"> (Artificial Intelligent System for Detecting and Analyzing PMDs and Oral Cancer)</h4>

{% if data is undefined or data.get('uploadedImage') is none %}
  <div class="container-fluid">
    <div class="row d-flex justify-content-center align-items-center text-center">
      <div class="col-8 col-xs-2 d-flex justify-content-center align-items-center">
        <form class="p-3 text-center" action="/upload_image/osm" method="post" enctype="multipart/form-data">
          <input id="file-upload1" type="file" name="imageList" onchange="form.submit()" accept="image/*" multiple hidden />
          <div class="d-flex align-items-center" style="width: 100%">
            <label for="file-upload1" class="card d-flex justify-content-center align-items-center" style="
                  border-style: dashed;
                  border-color: rgb(0, 229, 255); 
                  border-width: 2px;
                  width: 22rem;
                  height: 20  rem;
                  cursor: pointer;
                  padding: 10px;
                ">
              <div class="d-flex justify-content-center align-items-center img-responsive">
                <img src="{{url_for('static', filename='upload_icon.png')}}" style="width: 30%;" class="card-img-top">
              </div>
              คลิกเพื่ออัพโหลดรูปภาพ<br />(กรุณาอัพโหลดรูปช่องปากที่ได้มาตรฐานเท่านั้น)
            </label>
          </div>
        </form> 
      </div>
    </div>
  </div>
{% else %}
  <div class="p-3 text-center d-flex justify-content-center">
    <div class="col-md-8">
      <img id="previewImage" src="{{ url_for('image.load_image', folder='temp', user_id=session['user_id'], imagename=data['uploadedImage']) }}"
        class="card d-flex mx-auto" alt="" />
      <div class="my-3">
        <a class="btn btn-outline-warning mb-2" href="/upload_image/osm">เปลี่ยนรูป</a>
        <form action="{{ url_for('image.upload_image', role='osm', submission='false') }}" method="post" enctype="multipart/form-data">
          <input name="uploadedImage" type="text" value="{{data['uploadedImage']}}" hidden />
          <input name="rotation_submitted" type="submit" class="btn btn-outline-primary mb-2" value="คนไข้ควรหัวตั้งขึ้น หรือ กดปุ่มนี้เพื่อหมุนรูป"/>
        </form>
        <form id="submitimgForm" action="{{ url_for('image.upload_image', role='osm', submission='true') }}" method="post" enctype="multipart/form-data" >
          <div id="submitbtn" onclick="dataSubmission()" class="btn btn-success mb-2">ยืนยัน</div>
          <div id="errorBox" class="alert alert-danger" role="alert" style="display: none;"></div>
          <div class="border p-3 rounded-3 my-2">
            <div class="card-body">
              <div class="justify-content-center">
                <div class="d-flex align-items-center justify-content-start">
                  <p class="card-title text-start"> 
                    <span  style="color: red; font-weight: bold;">สำคัญ: </span>
                    ขอความร่วมมือแจ้งสถานที่ตรวจคัดกรอง โดยกรอกอย่างใดอย่างหนึ่ง ตำบล, อำเภอ, จังหวัด หรือรหัสไปรษณีย์ แล้วเลือกสถานที่ (หากไม่ทราบให้ปล่อยว่างไว้)
                  </p>
                </div>
                <div class="mt-2">
                  <input class="form-control" placeholder="ค้นหาตาม ตำบล, อำเภอ, จังหวัด หรือ รหัสไปรษณีย์" type="text" name="locationSearch" id="locationSearch" required>
                  <input type="hidden" id="location" name="location"
                    {% if session['user']['default_location']  %}
                      value="{{ session['user']['default_location'] }}"
                    {% endif %}
                  >
                </div>
                <div class="mt-3 d-flex row justify-content-center align-items-center" id="locationContainer" style="color: green">
                  {% if data['default_location_text']  %}
                      {{ data['default_location_text'] }} 
                    <span style="color: black">
                      (หากไม่ใช่สถานที่ตรวจคัดกรองที่ถูกต้อง ให้แก้ไขจากช่องค้นหาด้านบน)
                    </span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          <div class="loginContainer border p-3 rounded-3 my-2">
            <div class="card-body">
              <p class="card-title"> กรุณากรอกเลขประจำตัวประชาชนของผู้ป่วย </p>
              <div class="row mt-2 justify-content-center">
                <div id="patientIDContainer" class="col-6" style="display: block;">
                  <input class="form-control" placeholder="เลขประจำตัว ปชช. 13 หลัก" maxlength="13" type="text" name="inputIdentityID" id="inputIdentityID" /> 
                </div>
                <div class="mt-3 d-flex justify-content-center align-items-center" id="patientInfoContainer"></div>
                <input name="patient_id" id="patient_id" type="text" value="" hidden />
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endif %}
{% include 'examples_footer.html' %}
{% include 'terms_footer.html' %}
{% endblock %}

{% block script %}
<script>
  // Call earthchie/jquery.Thailand.js to auto-complete these fields
  const patientLocationContainer = document.getElementById('locationContainer')
  const patientLocation = document.getElementById('location')
  $.Thailand({ 
    $search: $('#locationSearch'), // input ของช่องค้นหา
    onDataFill: function(data){ // callback เมื่อเกิดการ auto complete ขึ้น
        const myJSON = JSON.stringify(data); 
        patientLocationContainer.innerHTML = "สถานที่คัดกรอง: ตำบล"+data['district'] +" อำเภอ"+data['amphoe'] + " จังหวัด"+data['province'] + " " + data['zipcode'];
        patientLocationContainer.style.color = 'green'
        patientLocation.value = myJSON;
    }
  });
</script>

<script>
  
  // Define the const variable involves in the following script
  const errorBox = document.getElementById("errorBox")
  const inputIdentityID = document.getElementById('inputIdentityID')
  const patientIDContainer = document.getElementById('patientIDContainer')
  const patientInfoContainer = document.getElementById('patientInfoContainer')
  const patientIDInput = document.getElementById('patient_id')

  inputIdentityID.addEventListener('input',function(e){
    checkPatientID( patientID = e.target.value)
  })

  function checkPatientID(patientID){
    if(patientID.length == 13){
      // Make an AJAX request to Flask server
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/get_patient_info', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.onreadystatechange = function () {
          patientInfoContainer.style.display = 'block';
          if (xhr.readyState === 4 && xhr.status === 200) {
            var patientInfo = JSON.parse(xhr.responseText)
            patientInfoContainer.style.color = 'green'
            patientInfoContainer.innerHTML = "ผู้ป่วยชื่อ "+patientInfo.name+" "+patientInfo.surname
            patientIDInput.value = patientInfo.patient_id
          }else{
            patientInfoContainer.style.color = 'red'
            patientInfoContainer.innerHTML="ไม่พบข้อมูลผู้ป่วยในระบบ (กรุณาลงทะเบียนข้อมูลผู้ป่วยภายหลัง)"
            patientIDInput.value = ""
          }
        }
      // Send the input value to the server
      xhr.send('patient_id=' + patientID);
    }else{
      patientInfoContainer.style.display = 'none'
      patientInfoContainer.innerHTML=""
      patientIDInput.value = ""
    }
  }

  function isValidPatientID(patientID) {
    const idPattern = /^\d{13}$/
    return idPattern.test(patientID)
  }

  function dataSubmission() {

      if (inputIdentityID.value!='' && !isValidPatientID(inputIdentityID.value)) {
        errorBox.style.display = 'block'
        inputIdentityID.style.borderColor = 'red'
        errorBox.innerHTML = 'กรุณาเลขประจำตัวประชาชนให้ถูกต้อง'
      }else{
        inputIdentityID.style.borderColor = ''
        document.getElementById("submitbtn").disabled = true
        document.getElementById("submitimgForm").submit()
      }
}

</script>
{% endblock %}