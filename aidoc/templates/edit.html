{% extends "./base.html" %}

{% block title %} RiskOCA | Edit User {% endblock %}

{% block content %}
<div>
    <h3>ข้อมูลผู้ใช้</h3>
</div>


<div class="container-md">
    <form id="editUserForm" action="/edit_page" method="POST" class="row g-3 my-4">
        <input type="hidden" name="_method" value="PUT">  <!-- Hidden input to indicate PUT method -->
        
        <!-- Form fields as before -->
        <div class="col-md-6">
            <label for="firstname" class="form-label">Firstname</label>
            <input class="form-control" type="text" name="name" id="firstname" value="">
        </div>

        <div class="col-md-6">
            <label for="lastname" class="form-label">Lastname</label>
            <input class="form-control" type="text" name="surname" id="lastname" value="">
        </div>

        <!-- work -->
        <div class="col-md-6">
            <label for="work" class="form-label">Work</label>
            <select id="job_position" name="job_position" class="form-control" required>
                <option value="" hidden></option>
                <option value="OSM" >อสม.</option>
                <option value="Dental Nurse">ทันตาภิบาล/เจ้าพนักงานทันตสาธารณสุข</option>
                <option value="Dentist">ทันตแพทย์</option>
                <option value="Oral Pathologist">ทันตแพทย์เฉพาะทาง วิทยาการวินิจฉัยโรคช่องปาก</option>
                <option value="Oral and Maxillofacial Surgeon">ทันตแพทย์เฉพาะทาง ศัลยศาสตร์ช่องปากและแม็กซิลโลเฟเชียล</option>
                <option value="Physician">แพทย์</option>
                <option value="Public Health Technical Officer">นักวิชาการสาธารณสุข</option>
                <option value="Computer Technical Officer">นักวิชาการคอมพิวเตอร์/นักวิจัย/ผู้พัฒนาระบบ</option>
                <option value="Other Public Health Officer">ข้าราชการ/เจ้าพนักงานกระทรวงสาธารณสุข</option>
                <option value="Other Government Officer">เจ้าหน้าที่รัฐอื่น</option>
                <option value="General Public">บุคคลทั่วไป</option>
            </select>
        </div>
        
        <!-- license -->
        <div class="col-md-6">
            <label for="license" class="form-label">License</label>
            <input class="form-control" type="text" name="license" id="license" value="">
        </div>

        <!-- hospital -->
        <div class="col-md-6">
            <label for="hospital" class="form-label">Hospital</label>
            <input class="form-control" type="text" name="hospital" id="hospital" value="">
        </div>

        <!-- province -->
        <div class="col-md-6">
            <label for="province" class="form-label">Province</label>
            <input class="form-control" type="text" name="province" id="province" value="">
        </div>

        <div class="col-md-6">
            <label for="province" class="form-label">National ID</label>
            <input class="form-control" type="text" name="nationalId" id="nationalId" value="">
        </div>

        <div class="col-md-6">
            <label for="province" class="form-label">Phone</label>
            <input class="form-control" type="text" name="phone" id="phone" value="">
        </div>



        <div class="col-12">
            <label for="email" class="form-label">E-mail</label>
            <input class="form-control" type="text" name="email" id="email" value="">
        </div>

        <!-- role -->
        <fieldset class="row my-3">
            <legend class="col-form-label col-sm-2 pt-0">Permission</legend>

            <div class="col-sm-10">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="role" id="admin" value="admin" >
                    <label class="form-check-label" for="admin">Admin</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="role" id="specialist" value="specialist">
                    <label class="form-check-label" for="dentist">Specialist</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="role" id="osm" value="osm">
                    <label class="form-check-label" for="user">Osm</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="role" id="user" value="user">
                    <label class="form-check-label" for="user">User</label>
                </div>
            </div>
        </fieldset>

        <!-- submit button -->
        <div class="col-12 d-flex justify-content-end">
            <button type="submit" class="btn btn-primary" id="editUserForm">Submit</button>
        </div>

    </form>
</div>

<script>
    function fetchUserData() {
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('id'); // Get the user ID from the URL query parameter
  
      if (!userId) {
        console.warn("User ID is missing in the query parameter.");
        return;
      }
  
      fetch(`http://127.0.0.1:5000/edit_user_info_api/?id=${userId}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      })
        .then((response) => response.json())
        .then((data) => {
          // Populate form fields with data
          if (data.name) document.getElementById('firstname').value = data.name;
          if (data.surname) document.getElementById('lastname').value = data.surname;
          if (data.job_position) document.getElementById('job_position').value = data.job_position;
          if (data.license) document.getElementById('license').value = data.license;
          if (data.hospital) document.getElementById('hospital').value = data.hospital;
          if (data.email) document.getElementById('email').value = data.email;
          if (data.province) document.getElementById('province').value = data.province;
          if (data.national_id) document.getElementById('nationalId').value = data.national_id;
          if (data.phone) document.getElementById('phone').value = data.phone;
  
          // Update roles checkboxes
          if (data.is_admin || data.is_osm || data.is_specialist || data.is_user) {
            document.getElementById('admin').checked = data.is_admin === 1;
            document.getElementById('specialist').checked = data.is_specialist === 1;
            document.getElementById('osm').checked = data.is_osm === 1;
            document.getElementById('user').checked = data.is_user === 1;
          }
        })
        .catch((error) => {
          console.error('Error fetching user data:', error);
        });
    }
  
    async function submitFormData(event) {
      event.preventDefault();  // Prevent the default form submission
  
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('id'); // Get the user ID
  
      const formData = {
        id: userId,
        name: document.getElementById('firstname').value,
        surname: document.getElementById('lastname').value,
        job_position: document.getElementById('job_position').value,
        license : document.getElementById('license').value,
        hospital: document.getElementById('hospital').value,
        province: document.getElementById('province').value,
        email: document.getElementById('email').value,
        national_id : document.getElementById('nationalId').value,
        phone : document.getElementById('phone').value,
        is_admin: document.getElementById('admin').checked ? 1 : 0,
        is_specialist: document.getElementById('specialist').checked ? 1 : 0,
        is_osm: document.getElementById('osm').checked ? 1 : 0,
        is_patient: document.getElementById('user').checked ? 1 : 0,
      };
  
      try {
        const response = await fetch("http://127.0.0.1:5000/submit_info_api/", {
          method: "PUT",  // Use PUT method for updating
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(formData),
        });
  
        if (response.ok) {
          alert("User information updated successfully!");
        } else {
          alert("Failed to update user information.");
        }
      } catch (error) {
        console.error("Error submitting form data:", error);
      }
    }
  
    document.getElementById('editUserForm').addEventListener('submit', submitFormData);
  
    fetchUserData(); // Call the function when the page loads
  </script>

{% endblock %}
