{% extends "./base.html" %}

{% block title %} AIDOC | Submission Records {% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <p class="fs-2 mb-0">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
  <button onclick="manualRefresh()" class="btn btn-outline-primary">
    <i class="fas fa-sync-alt me-1"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  </button>
</div>
<table id="user_manage" class="dataTable">
  <thead>
    <tr class="text-dark">
      <th>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
      <th>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö</th>
      <th>‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û</th>
      <th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î (‡∏£‡∏π‡∏õ)</th>
      <th>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
      <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  let fetchedData = []; // Store fetched data globally
  let dataTableInstance = null; // DataTables instance
  const CACHE_EXPIRY_TIME = 5 * 60 * 1000; // 5 minutes in milliseconds
  let isLoading = false; // Track loading state

  function initializePage() {
    // Check if we have cached data and if it's still valid
    const cachedData = localStorage.getItem("adminUserData");
    const cacheTimestamp = localStorage.getItem("adminUserDataTimestamp");
    const currentTime = new Date().getTime();

    if (cachedData && cacheTimestamp &&
      (currentTime - parseInt(cacheTimestamp)) < CACHE_EXPIRY_TIME) {
      // Use cached data if it exists and hasn't expired
      fetchedData = JSON.parse(cachedData);
      renderTable(fetchedData);
    } else {
      // Fetch fresh data if no cache or cache expired
      fetchAdminPage();
    }
  }

  function fetchAdminPage() {
    if (isLoading) return; // Prevent multiple simultaneous requests

    isLoading = true;
    updateRefreshButton(true);

    fetch(`/admin_page_api/`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        fetchedData = data; // Save fetched data

        // Store data in localStorage with timestamp
        localStorage.setItem("adminUserData", JSON.stringify(data));
        localStorage.setItem("adminUserDataTimestamp", new Date().getTime().toString());

        renderTable(fetchedData); // Render the table
        isLoading = false;
        updateRefreshButton(false);
      })
      .catch((error) => {
        console.error("Error:", error);

        const cachedData = localStorage.getItem("adminUserData");
        if (cachedData) {
          fetchedData = JSON.parse(cachedData);
          renderTable(fetchedData);
          console.log("Using cached data as fallback after fetch error");
        }

        isLoading = false;
        updateRefreshButton(false);
      });
  }

  function updateRefreshButton(loading) {
    const refreshBtn = document.querySelector('button[onclick="manualRefresh()"]');
    if (refreshBtn) {
      if (loading) {
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
        refreshBtn.disabled = true;
      } else {
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        refreshBtn.disabled = false;
      }
    }
  }

  function renderTable(data) {
    if (dataTableInstance) {
      dataTableInstance.destroy();
    }
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á DataTable ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    dataTableInstance = $("#user_manage").DataTable({
      data: data, // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≤‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
      columns: [
        {
          data: null,
          render: function (data, type, row) {
            return `${row.name} ${row.surname}`;
          }
        },
        {
          data: null,
          render: function (data, type, row) {
            const roleIcons = row.role && row.role.length
              ? row.role.map((role) => {
                switch (role.toLowerCase()) {
                  case "admin": return "ü§¥";
                  case "osm": return "üë®‚Äçüöí";
                  case "specialist": return "‚öïÔ∏è";
                  case "patient": return "üë®‚Äçü¶Ω";
                  case "dentist": return "üë®‚Äç‚öïÔ∏è";
                  default: return "‚ùì";
                }
              }).join(" ")
              : "‚ùì";
            return roleIcons;
          }
        },
        { data: "job_position" },
        { data: "province" },
        {
          data: "total_submit",
          render: function (data, type, row) {
            return `<button type="submit" style="text-decoration: none;  color: none; background: none; border: none; cursor: pointer;"
                  onclick="viewUserUploads('${row.id}')">
                    ${data}
                  </button>`;
          }
        },
        { data: "last_login" },
        {
          data: null,
          render: function (data, type, row) {
            return `
            <div class="d-flex">
              <form action="/edit?id=${row.id}" class="mx-1">
                <input name="id" type="hidden" value="${row.id}" />
                <input
                  class="btn btn-primary"
                  style="width: 100%"
                  type="submit"
                  value="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"
                />
              </form>
              <button
                class="btn btn-danger"
                style="width: 100%"
                onclick="confirmAndDelete('${row.id}')"
              >
                ‡∏•‡∏ö
              </button>
            </div>
          `;
          }
        }
      ],
      order: [[5, "desc"]],
      pageLength: 10,
      language: {
        search: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:",
        lengthMenu: "‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤",
        info: "‡πÅ‡∏™‡∏î‡∏á _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å _TOTAL_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
        paginate: {
          first: "‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å",
          last: "‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢",
          next: "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ",
          previous: "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤",
        },
      },
      stateSave: true,
      createdRow: function (row, data) {
        $(row).attr('data-id', data.id);
      }
    });
  }

  function confirmAndDelete(userId) {
    if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ?")) return;

    fetch(`/delete_user_api/`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ id: userId }),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`Failed to delete user: ${response.statusText}`);
        }
        alert("‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
        fetchedData = fetchedData.filter(user => Number(user.id) !== Number(userId));

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï localStorage
        localStorage.setItem("adminUserData", JSON.stringify(fetchedData));
        localStorage.setItem("adminUserDataTimestamp", new Date().getTime().toString());

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á - ‡πÄ‡∏£‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ DataTables API ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
        dataTableInstance.row(`tr[data-id="${userId}"]`).remove().draw();
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");
      });
  }

  function manualRefresh() {
    localStorage.removeItem("adminUserData");
    localStorage.removeItem("adminUserDataTimestamp");
    fetchAdminPage();
    window.location.reload()
  }
  function viewUserUploads(userId) {
    localStorage.setItem('user_id', userId);
    window.location.href = '/admin_record2';
  }

  initializePage();
</script>

{% endblock %}