{% extends "./base.html" %}

{% block title %} AIDOC | Submission Records {% endblock %}

{% block content %}
<div class="my-5 d-flex justify-content-between">
  <p class="fs-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
</div>
<table id="user_manage" class="dataTable">
  <thead>
    <tr class="text-dark" >
      <th>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
      <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
      <th>‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û</th>
      <th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î (‡∏£‡∏π‡∏õ)</th>
      <th>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
      <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  let fetchedData = []; // Store fetched data globally
  let dataTableInstance = null; // DataTables instance

  function fetchAdminPage() {
    fetch(`/admin_page_api/`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        fetchedData = data; // Save fetched data
        renderTable(fetchedData); // Render the table initially
      })
      .catch((error) => {
        console.error("Error:", error);
      });
  }

  function renderTable(data) {
    const tbody = document.querySelector("#user_manage tbody");
    tbody.innerHTML = ""; // Clear existing rows

   
    data.forEach((user) => {
      const row = document.createElement("tr");
      const roleIcons = user.role
      .map((role) => {
      switch (role.toLowerCase()) {
        case "admin":
          return "ü§¥";
        case "osm":
          return "üë®‚Äçüöí";
        case "specialist":
          return "‚öïÔ∏è";
        case "patient":
          return "üë®‚Äçü¶Ω";
        default:
          return "üë®‚Äç‚öïÔ∏è"; // Default icon for unknown roles
      }
    })
    .join(" "); // Join icons with a space for display
      row.innerHTML = `
        <td> ${user.name} ${user.surname}</td>
        <td> ${roleIcons}</td>
        <td> ${user.job_position}</td>
        <td>${user.province}</td>
        <td>${user.total_submit}</td>
        <td>${user.last_login}</td>
        <td>
          <div class="d-flex">
            <form action="/edit?id=${user.id}" class="mx-1">
              <input name="id" type="hidden" value="${user.id}" />
              <input
                class="btn btn-primary"
                style="width: 100%"
                type="submit"
                value="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"
              />
            </form>
            <button
              class="btn btn-danger"
              style="width: 100%"
              onclick="confirmAndDelete('${user.id}')"
            >
              ‡∏•‡∏ö
            </button>
          </div>
        </td>
      `;

      tbody.appendChild(row);
    });

    // Reinitialize DataTables to ensure proper pagination
    if (dataTableInstance) {
      dataTableInstance.destroy(); // Destroy existing instance
    }
    dataTableInstance = $("#user_manage").DataTable({
      order: [[3, "desc"]],
      pageLength: 10, // Items per page
      language: {
        search: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:",
        lengthMenu: "‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤",
        info: "‡πÅ‡∏™‡∏î‡∏á _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å _TOTAL_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
        paginate: {
          first: "‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å",
          last: "‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢",
          next: "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ",
          previous: "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤",
        },
      },
    });
  }

  function filterTable() {
    const searchValue = document
      .getElementById("searchInput")
      .value.toLowerCase();

    // Filter data based on search input
    const filteredData = fetchedData.filter((user) =>
      Object.values(user)
        .join(" ")
        .toLowerCase()
        .includes(searchValue)
    );

    renderTable(filteredData); // Re-render the table with filtered data
  }

  function confirmAndDelete(userId) {
    if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ?")) return;

    const formData = { id: userId }; // Construct the payload

    fetch(`/delete_user_api/`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(formData), // Pass the ID in the body
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`Failed to delete user: ${response.statusText}`);
        }
        alert("‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        window.location.reload();
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");
      });
  }


  fetchAdminPage(); // Fetch data and render table on page load
</script>

{% endblock %}
