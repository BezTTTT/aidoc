{% extends "./base.html" %}

{% block title %} AIDOC | Submission Report {% endblock %}

{% block content %}

<div id="loadingIndicator" style="display: none; text-align: center; font-weight: bold; font-size: 60px; color: red; ">
  ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
</div>
<div id="mainContainer">
  <h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</h2>
<select name="selectedProvince" id="filterProvince" onchange="handleProvinceChange()"></select>
<div class="card p-3 m-3" id="xxxcard">
  <h5 class="card-title">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h5>
  <br>
  <div class="table-responsive">
    <table id="patientHistTable" class="table table-bordered" >
      <thead>
        <tr class="text-dark" style="width: 100%;">
          <th rowspan="2" class="align-middle" style="width: 10%;">‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏™‡πà‡∏á</th>
          <th rowspan="2" class="align-middle text-center" style="width: 10%;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏†‡∏≤‡∏û</th>
          <th colspan="3" class="text-center" style="width: 20%;">‡∏ú‡∏•‡∏Ñ‡∏≥‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏î‡∏¢ AI</th>
          <th colspan="7" class="text-center" style="width: 60%;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th>
        </tr>
        <tr>
          <th class="text-center align-middle">OPMD</th>
          <th class="text-center align-middle">OSCC</th>
          <th class="text-center align-middle">NORMAL</th>

          <th class="text-center align-middle" style="width: 8.5%;">OPMD</th>
          <th class="text-center align-middle" style="width: 8.5%;">OSCC</th>
          <th class="text-center align-middle" style="width: 8.5%;">NORMAL</th>
          <th class="text-center align-middle" style="width: 8.5%;">‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</th>
          <th class="text-center align-middle" style="width: 8.5%;">‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</th>
          <th class="text-center align-middle" style="width: 8.5%;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (%)</th>
          <th class="text-center align-middle" style="width: 9%;">‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</th>
        </tr>
      </thead>
      <tbody id = FirstTable> 
      </tbody>
    </table>
  </div>
  <br>
</div>
  <div class="card p-3 m-3" id="card">
    <h5 class="card-title">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</h5>
    <br>
    <div class="table-responsive">
      <table id="patientHistTable" class="table table-bordered" >
        <thead>
          <tr class="text-dark" style="width: 100%;">
            <th rowspan="2" class="align-middle" style="width: 10%;">‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏™‡πà‡∏á</th>
            <th rowspan="2" class="align-middle text-center" style="width: 10%;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏†‡∏≤‡∏û</th>
            <th colspan="3" class="text-center" style="width: 30%;">‡∏ú‡∏•‡∏Ñ‡∏≥‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏î‡∏¢ AI</th>
            <th colspan="7" class="text-center" style="width: 50%;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ï‡πà‡∏≠‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏Ç‡∏≠‡∏á AI</th>
          </tr>
          <tr>
            <th class="text-center align-middle">OPMD</th>
            <th class="text-center align-middle">OSCC</th>
            <th class="text-center align-middle">NORMAL</th>
            <th class="text-center align-middle" style="width: 30%;">Agree</th>
            <th class="text-center align-middle" style="width: 30%;">Dissagree</th>
          </tr>
        </thead>
        <tbody id="specialistTable">
        </tbody>
      </table>
    </div>
  </div>
    <div class="card p-3 m-3" id="card">
      <div class="table-responsive">
        <table id="summaryTable" class="table table-bordered" >
          <thead>
            <tr class="text-dark" style="width: 100%;">
              <th rowspan="2" style="width: 40%;" class="align-middle">‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÅ‡∏•‡∏∞‡∏ó‡∏±‡∏ô‡∏ï‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</th>
              <th rowspan="2" style="width: 20%;" class="align-middle text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏†‡∏≤‡∏û</th>
              <th colspan="3" style="width: 40%;" class="text-center">‡∏ú‡∏•‡∏Ñ‡∏≥‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏î‡∏¢ AI</th>
            </tr>
            <tr>
              <th class="text-center">OPMD</th>
              <th class="text-center">OSCC</th>
              <th class="text-center">NORMAL</th>
            </tr>
          </thead>
          <tbody id="pictureCountTable"> 
          </tbody>
        </table>
      </div>
    </div>
</div>
<script>
  let isProvincePopulated = false;
  getReport("‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®")
  // Function to get the report
  function getReport(province) {
    const role = 'admin'; // Example role 
    const loadingIndicator = document.getElementById('loadingIndicator');
    const mainContent = document.getElementById('mainContainer');
    mainContent.style.display = 'none';
    loadingIndicator.style.display = 'block';
    let fetchReport = ""
    if(province == "‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®"){
      fetchReport = fetch(`/report_api/`, {
      method: 'GET',
      headers: {
        'x-role': role, // Custom header with role
        'Content-Type': 'application/json', // Optional content type
      },
    })
    }else{
      fetchReport = fetch(`/report_api/?province=${province}`, {
      method: 'GET',
      headers: {
        'x-role': role, // Custom header with role
        'Content-Type': 'application/json', // Optional content type
      },
    })
  }
      fetchReport.then((response) => response.json()) // Assuming the response is JSON
      .then((data) => {
        populateProvince(data)
        populateFirstTable(data)
        populateSpecialistTable(data)
        populatePictureCountTable(data) 
    })
      .catch((error) => {
        console.error('Error:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      })
      .finally(() => {
        mainContent.style.display= 'block';
        loadingIndicator.style.display = 'none';
      });
  }
  
  function handleProvinceChange() {
  const province = document.getElementById('filterProvince').value;
  getReport(province);
}


  function populateFirstTable(data){
    const firstTable = document.getElementById('FirstTable');
  firstTable.innerHTML = ''; // Clear existing rows if any

  if (data.patient_and_osm) {
    // Extract osm, patient, and total data
    const { osm, patient, total } = data.patient_and_osm;

    const createRow = (label, entry) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${label}</td>
        <td class="text-center">
        {% set default_data = {'search': ''} %}
        <form action="/record/admin" method="POST">
          <input
            type="text"
            id="search-input"
            name="search"
            value="{{ default_data.search }}"
            style="display:none"
        >
          <button type="submit" style="text-decoration: none; color: black; background: none; border: none; cursor: pointer;">
            ${entry.total_pic}
          </button>
        </form>
        </td>
        <td class="text-center">
        {% set default_data = {'search': 'opmd'} %}
        <form action="/record/admin" method="POST">
          <input
            type="text"
            id="search-input"
            name="search"
            value="{{ default_data.search }}"
            style="display:none"
        >
          <button type="submit" style="text-decoration: none; color: black; background: none; border: none; cursor: pointer;">
            ${entry.ai_predict.opmd}
          </button>
        </form>
        </td>
        <td class="text-center">
        {% set default_data = {'search': 'oscc'} %}
        <form action="/record/admin" method="POST">
          <input
            type="text"
            id="search-input"
            name="search"
            value="{{ default_data.search }}"
            style="display:none"
        >
          <button type="submit" style="text-decoration: none; color: black; background: none; border: none; cursor: pointer;">
            ${entry.ai_predict.oscc}
          </button>
        </form>
        </td>
        <td class="text-center">
        {% set default_data = {'search': 'normal'} %}
        <form action="/record/admin" method="POST">
          <input
            type="text"
            id="search-input"
            name="search"
            value="{{ default_data.search }}"
            style="display:none"
        >
          <button type="submit" style="text-decoration: none; color: black; background: none; border: none; cursor: pointer;">
            ${entry.ai_predict.normal}
          </button>
        </form>
        </td>
        <td class="text-center">
            <a href="/record/admin?value=opmd"
            style="text-decoration: none; color: black; cursor: pointer;">
              ${entry.dentist_diagnose.opmd}
            </a>
        </td>
        <td class="text-center">
            <a href="/record/admin?value=oscc"
            style="text-decoration: none; color: black; cursor: pointer;">
              ${entry.dentist_diagnose.oscc}
            </a>
        </td>
        <td class="text-center">
            <a href="/record/admin"&value=normal"
            style="text-decoration: none; color: black; cursor: pointer;">
              ${entry.dentist_diagnose.normal}
            </a>
        </td>
        <td class="text-center">
            <a href="/record/admin&value=BAD_IMG"
            style="text-decoration: none; color: black; cursor: pointer;">
              ${entry.dentist_diagnose.poor_image}
            </a>
        </td>
        <td class="text-center">
            <a href="/record/admin?value=others"
            style="text-decoration: none; color: black; cursor: pointer;">
              ${entry.dentist_diagnose.others}
            </a>
        </td>
        <td class="text-center">
              ${entry.accuracy}
        </td>
        <td class="text-center">
            <a href="/record/admin?value=not_diagnosed"
            style="text-decoration: none; color: black; cursor: pointer;">
              ${entry.dentist_diagnose.not_diagnosed}
            </a>
        </td>

      `;
      firstTable.appendChild(row);
    };

    // Add rows for osm, patient, and total
    createRow('‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', patient);
    createRow('‡∏≠‡∏™‡∏°.', osm);
    createRow('‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', total);
    }
  }
  function populateSpecialistTable(data) {
  const specialistTable = document.getElementById('specialistTable');
  specialistTable.innerHTML = ''; // Clear existing rows if any

  if (data.specialist && Array.isArray(data.specialist)) {
    data.specialist.forEach((specialist, index) => {
      const isLastSpecialist = index === data.specialist.length - 1
      const row = document.createElement('tr');

      // Populate cells for the current specialist
      row.innerHTML = `
        <td>${isLastSpecialist ? '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : specialist.job }</td>
        <td class="text-center">${specialist.total_pic }</td>
        <td class="text-center">${specialist.ai_predict.opmd }</td>
        <td class="text-center">${specialist.ai_predict.oscc }</td>
        <td class="text-center">${specialist.ai_predict.normal }</td>
        <td class="text-center" >${specialist.dentist_diagnose.agree }</td>
        <td class="text-center">${specialist.dentist_diagnose.disagree}</td>
      `;

      specialistTable.appendChild(row);
    });
  }
}

 function populatePictureCountTable(data){
  const pictureCountTable = document.getElementById('pictureCountTable')
  pictureCountTable.innerHTML = ''
  if(data.total_pic){
    const row = document.createElement('tr')
    row.innerHTML = `
    <td>‡∏£‡∏ß‡∏°</td>
    <td class="text-center">${data.total_pic.total_pic}</td>
    <td class="text-center">${data.total_pic.ai_predict.opmd }</td>
    <td class="text-center">${data.total_pic.ai_predict.oscc }</td>
    <td class="text-center">${data.total_pic.ai_predict.normal }</td>
    `

    pictureCountTable.appendChild(row);
  }
 }

 function populateProvince(data) {
  const provinceDropdown = document.getElementById('filterProvince');

  if (!isProvincePopulated && provinceDropdown.options.length <= 1) {
    const defaultOption = document.createElement('option');
    defaultOption.value = "‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®";
    defaultOption.textContent = "‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®";
    provinceDropdown.appendChild(defaultOption);

    let count = 1;
    data.total_province.forEach(province => {
      const option = document.createElement('option');
      option.value = province;

      // Add medal emoji for the first three provinces
      if (count === 1) {
        option.textContent = "ü•á " + province;
      } else if (count === 2) {
        option.textContent = "ü•à " + province;
      } else if (count === 3) {
        option.textContent = "ü•â " + province;
      } else {
        option.textContent = province;
      }

      provinceDropdown.appendChild(option);
      count++;
    });

    isProvincePopulated = true;
  }
}
</script>
{% endblock %}