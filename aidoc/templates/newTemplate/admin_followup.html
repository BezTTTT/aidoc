{% extends "./base.html" %}

{% block title %} AIDOC | Submission Records {% endblock %}

{% block content %}

<h2>ระบบการให้คำวินิจฉัยของทันตแพทย์ผู้เชี่ยวชาญ</h2>
<p>ผู้เชี่ยวชาญ: {{ g.user['name'] }} {{ g.user['surname'] }} ({{ g.user['job_position_th'] }}) </p>

{% if data|length == 0 %}
<div class="col-12 mt-2">
    <p class="text-center text-danger">ไม่พบข้อมูล</p>
</div>
<div class="col-12 mt-2">
    <p class="text-center text-danger">ไม่พบข้อมูล</p>
</div>
{% else %}
<div class="mt-2">
    จำนวนรายการทั้งหมด: {{ dataCount }} รายการ
</div>
<div class="d-flex flex-wrap gap-2">
    <a href="{{ url_for('webapp.export_followup_records') }}" class="btn btn-warning mb-3">
        Specialist Export
    </a>
    <a href="{{ url_for('webapp.export_followup_records_for_contact') }}" class="btn btn-primary mb-3">
        Contact Export
    </a>
</div>
{% endif %}

<!-- Loop through paginated data -->
<div class="row mt-4" id="cards-container">
    {% for item in data %}
    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12 mb-3 card-item" 
         data-status="{{ item['followup_request_status'] }}"
         data-prediction="{{ item['ai_prediction'] }}"
         data-date="{{ item['created_at']|default('') }}">
        <div class="card h-100">
            <div class="d-flex justify-content-center align-items-center p-2">
                <a href="{{ url_for('image.load_image', folder='upload', user_id=item['owner_id'], imagename=item['fname']) }}"
                    target="_blank">
                    <img src="{{ url_for('image.load_image', folder='upload_thumbnail', user_id=item['owner_id'], imagename=item['fname']) }}"
                        class="card-img-top rounded" alt="Image Preview"
                        style="object-fit: contain; width: 100%; height:100%; max-height:250px;" />
                </a>
            </div>
            <div class="card-body text-center d-flex flex-column" style="flex: 1;">
                <div class="badge position-absolute top-0 end-0 m-2 
                    {% if item['followup_request_status'] == 'On Specialist' %} bg-warning text-dark 
                    {% elif item['followup_request_status'] == 'On Contact' %} bg-primary 
                    {% elif item['followup_request_status'] == 'On Treatment' %} bg-success 
                    {% elif item['followup_request_status'] == 'Closed' %} bg-secondary 
                    {% endif %}">
                    {{ item['followup_request_status'] }}
                </div>
                <h6 class="fs-6 fw-bold text-primary">
                    ผลการพยากรณ์ของ AI:
                    {% if item['ai_prediction'] == 0 %}
                    <span class="text-dark">Normal</span>
                    {% elif item['ai_prediction'] == 1 %}
                    <span class="text-warning">OPMD</span>
                    {% else %}
                    <span class="text-danger">OSCC</span>
                    {% endif %}
                    </span>
                </h6>
                {% if item['created_at'] %}
                <p class="text-muted small mb-2">วันที่: {{ item['created_at']|default('ไม่ระบุวันที่') }}</p>
                {% endif %}
                
                <!-- Add new diagnosis button -->
                <a href="/diagnosis/specialist/{{ item['id'] }}" class="btn btn-info btn-sm mb-3">ดูรายละเอียด</a>
                
                <form action="{{url_for('webapp.confirmFeedback' , submission_id=item['id']) }}" method="POST">
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm feedback-select" name="feedback" data-item-id="{{ item['id'] }}" required>
                            <option value="" selected disabled>Feedback</option>
                            <option value="OPMD" {% if item.followup_feedback=='OPMD' %}selected{% endif %}>OPMD</option>
                            <option value="OSCC" {% if item.followup_feedback=='OSCC' %}selected{% endif %}>OSCC</option>
                            <option value="Benign" {% if item.followup_feedback=='Benign' %}selected{% endif %}>Benign</option>
                            <option value="Others" {% if item.followup_feedback=='Others' %}selected{% endif %}>Others</option>
                            <option value="Normal" {% if item.followup_feedback=='Normal' %}selected{% endif %}>Normal</option>
                            <option value="BAD_IMG" {% if item.followup_feedback=='BAD_IMG' %}selected{% endif %}>ภาพไม่ได้มาตรฐาน</option>
                        </select>
                        <select class="form-select form-select-sm note-select" name="note" 
                            data-item-id="{{ item['id'] }}" 
                            data-selected="{{ item.followup_note if item.followup_note else '' }}"
                            {% if item.followup_note %} {% else %}disabled{% endif %}>
                            <option value="" selected disabled>Note</option>
                        </select>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-secondary confirm-btn" type="submit" data-item-id="{{ item['id'] }}" disabled>Confirm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>


<!-- Pagination links -->
<div class="pagination d-flex justify-content-center align-items-center">
    {% if current_page > 1 %}
    <a href="?page=1" class="btn page-link m-2 text-secondary">&laquo; หน้าแรก</a>
    <a href="?page={{ current_page - 1 }}" class="btn page-link m-2 text-secondary">&lsaquo; ก่อนหน้า</a>
    {% endif %}
    {% for page_num in range(1, total_pages + 1) %}
    {% if page_num == current_page %}
    <span class="current-page page-link m-2 text-secondary">หน้าปัจจุบัน : {{ page_num }} จาก {{ total_pages }}</span>
    {% endif %}
    {% endfor %}
    {% if current_page < total_pages %}
    <a href="?page={{ current_page + 1 }}" class="btn page-link m-2 text-secondary">ถัดไป &rsaquo;</a>
    <a href="?page={{ total_pages }}" class="btn page-link m-2 text-secondary">หลังสุด &raquo;</a>
    {% endif %}
</div>
{% endblock %}

{% block script %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Form functionality
        document.querySelectorAll(".feedback-select").forEach(select => {
            var itemId = select.dataset.itemId;
            updateNoteOptions(itemId, true); // Load existing selections
            storeInitialValues(itemId);
            checkFormCompletion(itemId); // Initialize button state
    
            select.addEventListener("change", function () {
                updateNoteOptions(itemId, false);
                checkFormCompletion(itemId);
            });
        });
    
        document.querySelectorAll(".note-select").forEach(select => {
            select.addEventListener("change", function () {
                var itemId = select.dataset.itemId;
                checkFormCompletion(itemId);
            });
        });
    
        document.querySelectorAll("form").forEach(form => {
            form.addEventListener("submit", function (event) {
                event.preventDefault();
                let formData = new FormData(this);
                let submitBtn = this.querySelector(".confirm-btn");
                submitBtn.disabled = true;
    
                fetch(this.action, {
                    method: "POST",
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        let card = this.closest(".col-lg-3");
                        if (card) {
                            card.style.opacity = "0";
                            setTimeout(() => {
                                card.remove();
                            }, 500);
                        }
                    }
                })
                .catch(error => console.error("Error:", error))
                .finally(() => {
                    submitBtn.disabled = false;
                });
            });
        });
    });
    
    // Store initial values for detecting changes
    function storeInitialValues(itemId) {
        var feedback = document.querySelector(`.feedback-select[data-item-id='${itemId}']`);
        var note = document.querySelector(`.note-select[data-item-id='${itemId}']`);
    
        feedback.setAttribute("data-initial", feedback.value || "");
        note.setAttribute("data-initial", note.value || "");
    }
    
    // Update note options dynamically when feedback changes
    function updateNoteOptions(itemId, isPageLoad = false) {
        var feedback = document.querySelector(`.feedback-select[data-item-id='${itemId}']`).value;
        var note = document.querySelector(`.note-select[data-item-id='${itemId}']`);
        var selectedNote = note.getAttribute("data-selected"); // Get pre-selected value
    
        var optionsMap = {
            "Normal": ["ปกติ"],
            "Benign": ["ปกติ", "ตรวจเพิ่มเติม"],
            "OPMD": ["พบแพทย์ด่วน", "ตรวจเพิ่มเติม"],
            "OSCC": ["พบแพทย์ด่วน", "ตรวจเพิ่มเติม"],
            "BAD_IMG": ["ภาพเบลอ", "ถ่ายใหม่"],
            "Others": ["พบแพทย์ด่วน", "ตรวจเพิ่มเติม", "รอดูอาการ", "ปกติ", "ภาพเบลอ", "ถ่ายใหม่"]
        };
    
        // Reset note dropdown with placeholder
        note.innerHTML = '<option value="" selected disabled>Note</option>';
    
        if (!feedback) {
            note.disabled = true;
            checkFormCompletion(itemId);
            return;
        }
    
        var selectedOptions = optionsMap[feedback] || [];
    
        selectedOptions.forEach(function (optionText) {
            var option = document.createElement("option");
            option.value = optionText;
            option.textContent = optionText;
    
            // Set the pre-selected note if it's a page load
            if (isPageLoad && optionText === selectedNote) {
                option.selected = true;
            }
    
            note.appendChild(option);
        });
    
        // Enable dropdown only if there are options
        note.disabled = selectedOptions.length === 0;
    
        checkFormCompletion(itemId);
    }
    
    // Enable/disable confirm button based on selection and changes
    function checkFormCompletion(itemId) {
        var feedback = document.querySelector(`.feedback-select[data-item-id='${itemId}']`);
        var note = document.querySelector(`.note-select[data-item-id='${itemId}']`);
        var confirmBtn = document.querySelector(`.confirm-btn[data-item-id='${itemId}']`);
    
        var feedbackValue = feedback.value;
        var noteValue = note.value;
        var noteRequired = !note.disabled;
    
        var initialFeedback = feedback.getAttribute("data-initial");
        var initialNote = note.getAttribute("data-initial");
    
        var hasChanged = (feedbackValue !== initialFeedback) || (noteValue !== initialNote);
    
        // Enable button only if:
        // 1. Feedback has a valid selection (not the default)
        // 2. If note dropdown is enabled, it must have a selection
        // 3. Some change from initial values is detected
        var isValid = feedbackValue && feedbackValue !== "Feedback" && 
                     (!noteRequired || (noteRequired && noteValue && noteValue !== "Note")) && 
                     hasChanged;
    
        if (isValid) {
            confirmBtn.disabled = false;
            confirmBtn.classList.remove("btn-secondary");
            confirmBtn.classList.add("btn-success");
        } else {
            confirmBtn.disabled = true;
            confirmBtn.classList.remove("btn-success");
            confirmBtn.classList.add("btn-secondary");
        }
    }
</script>
{% endblock %}