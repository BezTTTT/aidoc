{% extends "./base.html" %}

{% block title %} AIDOC | Submission Records {% endblock %}

{% block content %}

<h2>ระบบการบริหารจัดการภาพของผู้ดูแลระบบ</h2>
<p>ผู้ดูแลระบบ: {{ g.user['name'] }} {{ g.user['surname'] }} (Username: {{ g.user['username'] }}) </p>
    
{% if data|length == 0 %}
    <div class="col-12 mt-2">
        <p class="text-center text-danger">ไม่พบข้อมูล</p>
    </div>
{% else %}
    <div class="mt-2">
        จำนวนรายการทั้งหมด {{dataCount}} รายการ
    </div>
{% endif %}

<!-- Loop through paginated data -->
<div class="row mt-4">
    {% for item in data %}
    
        <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12 mb-3">
            <div class="card h-100">
                <div class="d-flex justify-content-center align-items-center p-2">
                    <a href="{{ url_for('image.load_image', folder='upload', user_id=item['owner_id'], imagename=item['fname']) }}" target="_blank">
                        <img src="{{ url_for('image.load_image', folder='outlined_thumbnail', user_id=item['owner_id'], imagename=item['fname']) }}" 
                            class="card-img-top rounded" alt="Image Preview" 
                            style="object-fit: contain; width: 100%; height:100%; max-height:250px;"/>
                    </a>
                </div>
                <div class="card-body text-center d-flex flex-column" style="flex: 1;">  
                    <h6 class="fs-6 fw-bold text-primary">
                        ผลการพยากรณ์ของ AI:
                            {% if item['ai_prediction'] == 0 %}
                            <span class="text-dark">Normal</span>
                            {% elif item['ai_prediction'] == 1 %}
                            <span class="text-warning">OPMD</span>
                            {% else %}
                            <span class="text-danger">OPMD</span>
                            {% endif %}
                        </span>
                    </h6>
                    <form action = "{{url_for('webapp.confirmFeedback' , submission_id=item['id']) }}" method="POST">
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" id="feedback" name="feedback" required>
                                <option selected disabled hidden>Feedback</option>
                                <option value="OPMD" {% if item.followup_feedback == 'OPMD' %}selected{% endif %}>OPMD</option>
                                <option value="OSCC" {% if item.followup_feedback == 'OSCC' %}selected{% endif %}>OSCC</option>
                                <option value="Benign" {% if item.followup_feedback == 'Benign' %}selected{% endif %}>Benign</option>
                                <option value="Others" {% if item.followup_feedback == 'Others' %}selected{% endif %}>Others</option>
                                <option value="Normal" {% if item.followup_feedback == 'Normal' %}selected{% endif %}>Normal</option>
                                <option value="BAD_IMG" {% if item.followup_feedback == 'BAD_IMG' %}selected{% endif %}>ภาพไม่ได้มาตรฐาน</option>
                            </select>
                            <select class="form-select form-select-sm" id ="note" name="note" required>
                                <option selected disabled hidden>Note</option>
                                <option value="พบแพทย์ด่วน" {% if item.followup_note == 'พบแพทย์ด่วน' %}selected{% endif %} >พบแพทย์ด่วน</option>
                                <option value="ตรวจเพิ่มเติม" {% if item.followup_note == 'ตรวจเพิ่มเติม' %}selected{% endif %} >ตรวจเพิ่มเติม</option>
                                <option value="รอดูอาการ" {% if item.followup_note == 'รอดูอาการ' %}selected{% endif %}> รอดูอาการ </option>
                                <option value="ปกติ" {% if item.followup_note == 'ปกติ' %}selected{% endif %} >ปกติ</option>
                                <option value="ภาพเบลอ" {% if item.followup_note == 'ภาพเบลอ' %}selected{% endif %} >ภาพเบลอ</option>
                                <option value="ถ่ายใหม่" {% if item.followup_note == 'ถ่ายใหม่' %}selected{% endif %} >ถ่ายใหม่</option>
                            </select>
                        </div>
                        <div class="text-center mt-3">
                            <button class="btn btn-success" type="submit">Confirm</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% endfor %}
</div>


<!-- Pagination links -->
<div class="pagination d-flex justify-content-center align-items-center">
    {% if current_page > 1 %}
        <a href="?page=1" class="btn page-link m-2 text-secondary">&laquo; หน้าแรก</a>
        <a href="?page={{ current_page - 1 }}" class="btn page-link m-2 text-secondary">&lsaquo; ก่อนหน้า</a>
    {% endif %}
    {% for page_num in range(1, total_pages + 1) %}
        {% if page_num == current_page %}
            <span class="current-page page-link m-2 text-secondary">หน้าปัจจุบัน : {{ page_num }} จาก {{ total_pages }}</span>
        {% endif %}
    {% endfor %}
    {% if current_page < total_pages %}
        <a href="?page={{ current_page + 1 }}" class="btn page-link m-2 text-secondary">ถัดไป &rsaquo;</a>
        <a href="?page={{ total_pages }}" class="btn page-link m-2 text-secondary">หลังสุด &raquo;</a>
    {% endif %}
</div>
{% endblock %}

{% block script %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("form").forEach(form => {
            form.addEventListener("submit", function (event) {
                event.preventDefault();  // Prevent default form submission

                let formData = new FormData(this);

                fetch(this.action, {
                    method: "POST",
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        let card = this.closest(".col-lg-3"); 
                        let parentContainer = card.parentElement;
                        parentContainer.appendChild(card); // Move card to bottom

                        Toastify({
                            text: data.message,
                            duration: 3000,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "green",
                        }).showToast();
                    } else {
                        Toastify({
                            text: data.message,
                            duration: 3000,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "red",
                        }).showToast();
                    }
                })
                .catch(error => console.error("Error:", error));
            });
        });
    });
</script>
{% endblock %}