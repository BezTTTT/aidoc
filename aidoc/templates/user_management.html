{% extends "./base.html" %}

{% block title %} RiskOCA | Submission Records {% endblock %}

{% block content %}
<div class="my-5 d-flex justify-content-between">
      <p class="fs-2">จัดการผู้ใช้งาน</p>
      <div>
        <input
        id="searchInput"
        class="form-control"
        style="width: 300px;"
        type="text"
        placeholder="ค้นหาผู้ใช้งาน..."
        onkeyup="filterTable()"
        />
      </div>
    </div>
    <table id="user_manage" class="dataTable">
      <thead>
        <tr class="text-dark">
          <th>ชื่อ - นามสกุล</th>
          <th>อีเมล</th>
          <th>จังหวัด</th>
          <th>Action ล่าสุด</th>
          <th>จำนวนอัพโหลด (รูป)</th>
          <th>แก้ไข</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <script>
      let fetchedData = []; // Store fetched data globally
    
      function fetchAdminPage() {
        fetch(`http://127.0.0.1:5000/admin_page/`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            fetchedData = data; // Save fetched data
            renderTable(fetchedData); // Render the table initially
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }
    
      function renderTable(data) {
        const tbody = document.querySelector("#user_manage tbody");
        tbody.innerHTML = ""; // Clear existing rows
    
        data.forEach((user) => {
          const row = document.createElement("tr");
    
          row.innerHTML = `
            <td>
              <form action="/user_upload" method="post">
                <input name="id" type="hidden" value="${user.id}" />
                <button style="border: none; background: none" type="submit">
                  ${user.name} ${user.surname} (${user.role},${user.job_position})
                </button>
              </form>
            </td>
            <td>${user.email}</td>
            <td>${user.province}</td>
            <td>${user.last_action}</td>
            <td>${user.total_submit}</td>
            <td>
              <div class="d-flex justify-content-center">
                <form action="/edit?id=${user.id}" method="post" class="mx-1">
                  <div class="">
                    <input name="id" type="hidden" value="${user.id}" />
                    <input
                      class="btn btn-primary"
                      style="width: 100%"
                      type="submit"
                      value="แก้ไข"
                    />
                  </div>
                </form>
                <form
                  action="/admin/delete"
                  method="post"
                  onsubmit="return confirmDelete()"
                >
                  <div class="">
                    <input name="id" type="hidden" value="${user.id}" />
                    <input
                      class="btn btn-danger"
                      style="width: 100%"
                      type="submit"
                      value="ลบ"
                    />
                  </div>
                </form>
              </div>
            </td>
          `;
    
          tbody.appendChild(row);
        });
      }
    
      function filterTable() {
        const searchValue = document
          .getElementById("searchInput")
          .value.toLowerCase();
    
        // Filter data based on search input
        const filteredData = fetchedData.filter((user) =>
          Object.values(user)
            .join(" ")
            .toLowerCase()
            .includes(searchValue)
        );
    
        renderTable(filteredData); // Re-render the table with filtered data
      }
    
      function confirmDelete() {
        return confirm("คุณต้องการลบผู้ใช้นี้ใช่หรือไม่ ?");
      }
    
      fetchAdminPage(); // Fetch data and render table on page load
    </script>
    
{% endblock %}