{% extends "./base.html" %}

{% block title %} RiskOCA | Submission Report {% endblock %}

{% block content %}

<h2>รายงานสรุปการนำส่งรูปรายจังหวัด</h2>
<select name="selectedProvince" id="selectedProvince"></select>
<input type="submit" value="getReport" id="submitButton">
<script>
  getReport('')
  const provinces = [
    "กรุงเทพมหานคร", "กระบี่", "กาญจนบุรี", "กาฬสินธุ์", "กำแพงเพชร", "ขอนแก่น",
    "จันทบุรี", "ฉะเชิงเทรา", "ชลบุรี", "ชัยนาท", "ชัยภูมิ", "ชุมพร", "เชียงราย", "เชียงใหม่",
    "ตรัง", "ตราด", "ตาก", "นครนายก", "นครปฐม", "นครพนม", "นครราชสีมา", "นครศรีธรรมราช",
    "นครสวรรค์", "นนทบุรี", "นราธิวาส", "น่าน", "บึงกาฬ", "บุรีรัมย์", "ปทุมธานี", "ประจวบคีรีขันธ์",
    "ปราจีนบุรี", "ปัตตานี", "พระนครศรีอยุธยา", "พังงา", "พัทลุง", "พิจิตร", "พิษณุโลก", "เพชรบุรี",
    "เพชรบูรณ์", "แพร่", "พะเยา", "ภูเก็ต", "มหาสารคาม", "มุกดาหาร", "แม่ฮ่องสอน", "ยะลา", "ยโสธร",
    "ร้อยเอ็ด", "ระนอง", "ระยอง", "ราชบุรี", "ลพบุรี", "ลำปาง", "ลำพูน", "เลย", "ศรีสะเกษ",
    "สกลนคร", "สงขลา", "สตูล", "สมุทรปราการ", "สมุทรสงคราม", "สมุทรสาคร", "สระแก้ว", "สระบุรี",
    "สิงห์บุรี", "สุโขทัย", "สุพรรณบุรี", "สุราษฎร์ธานี", "สุรินทร์", "หนองคาย", "หนองบัวลำภู",
    "อ่างทอง", "อุดรธานี", "อุทัยธานี", "อุตรดิตถ์", "อุบลราชธานี", "อำนาจเจริญ"
  ];
  const selectElement = document.getElementById('selectedProvince');
  provinces.forEach(province => {
    const option = document.createElement('option');
    option.value = province;
    option.textContent = province;
    selectElement.appendChild(option);
  });
  // Function to get the report
  function getReport(province) {
    const role = 'admin'; // Example role value

    // Make the API call with query parameter and custom header
    fetch(`http://127.0.0.1:5000/report/?province=${province}`, {
      method: 'GET',
      headers: {
        'x-role': role, // Custom header with role
        'Content-Type': 'application/json', // Optional content type
      },
    })
      .then((response) => response.json()) // Assuming the response is JSON
      .then((data) => {
        populateSpecialistTable(data)
    Object.keys(data).forEach((key1) => {
        if (typeof data[key1] === 'object') {
            Object.keys(data[key1]).forEach((key2) => {
                if (key2 === 'total_pic') {
                    // Special case for total_pic
                    const element = document.getElementById(`${key1}`);
                    if (element) element.textContent = data[key1][key2];
                    console.log(`${key1}`, data[key1][key2]);
                } else if (typeof data[key1][key2] === 'object') {
                    Object.keys(data[key1][key2]).forEach((key3) => {
                        if (key3 === 'ai_predict' || key3 === 'dentist_diagnose') {
                            Object.keys(data[key1][key2][key3]).forEach((key4) => {
                                const element = document.getElementById(`${key1}_${key2}_${key3}_${key4}`);
                                if (element) element.textContent = data[key1][key2][key3][key4];
                                console.log(`${key1}_${key2}_${key3}_${key4}`, data[key1][key2][key3][key4]);
                            });
                        } else {
                            const element = document.getElementById(`${key1}_${key2}_${key3}`);
                            if (element) element.textContent = data[key1][key2][key3];
                            console.log(`${key1}_${key2}_${key3}`, data[key1][key2][key3]);
                        }
                    });
                } else {
                    const element = document.getElementById(`${key1}_${key2}`);
                    if (element) element.textContent = data[key1][key2];
                    console.log(`${key1}_${key2}`, data[key1][key2]);
                }
            });
        }
    })
  })
      .catch((error) => {
        console.error('Error:', error);
      });
  }
  document.getElementById('submitButton').addEventListener('click', (event) => {
    event.preventDefault(); // Prevent the default form submission behavior
    const province = document.getElementById('selectedProvince').value; // Get the selected province value
    report = getReport(province); // Call the function with the selected value
  });

  function populateSpecialistTable(data) {
  const specialistTable = document.getElementById('specialistTable');
  specialistTable.innerHTML = ''; // Clear existing rows if any

  if (data.specialist && Array.isArray(data.specialist)) {
    data.specialist.forEach((specialist, index) => {
      const isLastSpecialist = index === data.specialist.length - 1
      const row = document.createElement('tr');

      // Populate cells for the current specialist
      row.innerHTML = `
        <td id="specialist_${index}_job">${isLastSpecialist ? 'รวม' : specialist.job || ''}</td>
        <td class="text-center" id="specialist_${index}_total_pic">${specialist.total_pic || ''}</td>
        <td class="text-center" id="specialist_${index}_ai_predict_opmd">${specialist.ai_predict.opmd || ''}</td>
        <td class="text-center" id="specialist_${index}_ai_predict_oscc">${specialist.ai_predict.oscc || ''}</td>
        <td class="text-center" id="specialist_${index}_ai_predict_normal">${specialist.ai_predict.normal || ''}</td>
        <td class="text-center" id="specialist_${index}_dentist_diagnose_agree">${specialist.dentist_diagnose.agree || ''}</td>
        <td class="text-center" id="specialist_${index}_dentist_diagnose_disagree">${specialist.dentist_diagnose.disagree || ''}</td>
      `;

      specialistTable.appendChild(row);
    });
  }
}


</script>

<div class="card p-3 m-3" id="xxxcard">
  <h5 class="card-title">ตารางสรุปการนำส่งของประชาชนทั่วไป</h5>
  <br>
  <div class="table-responsive">
    <table id="patientHistTable" class="table table-bordered" >
      <thead>
        <tr class="text-dark" style="width: 100%;">
          <th rowspan="2" class="align-middle" style="width: 10%;">ผู้นำส่ง</th>
          <th rowspan="2" class="align-middle text-center" style="width: 10%;">จำนวนภาพ</th>
          <th colspan="3" class="text-center" style="width: 20%;">ผลคำวินิจฉัยโดย AI</th>
          <th colspan="7" class="text-center" style="width: 60%;">ความคิดเห็นของทันตแพทย์ที่เข้าร่วมโครงการ</th>
        </tr>
        <tr>
          <th class="text-center align-middle">OPMD</th>
          <th class="text-center align-middle">OSCC</th>
          <th class="text-center align-middle">NORMAL</th>

          <th class="text-center align-middle" style="width: 8.5%;">OPMD</th>
          <th class="text-center align-middle" style="width: 8.5%;">OSCC</th>
          <th class="text-center align-middle" style="width: 8.5%;">NORMAL</th>
          <th class="text-center align-middle" style="width: 8.5%;">ภาพไม่ได้มาตรฐาน</th>
          <th class="text-center align-middle" style="width: 8.5%;">อื่น ๆ</th>
          <th class="text-center align-middle" style="width: 8.5%;">ความแม่นยำ (%)</th>
          <th class="text-center align-middle" style="width: 9%;">ภาพที่ยังไม่ได้ตรวจ</th>
        </tr>
      </thead>
      <tbody>
        <tr id="patient">
          <td>ประชาชน</td>
          <td class="text-center" id = "patient_and_osm_patient_total_pic"></td>
          <td class="text-center" id = "patient_and_osm_patient_ai_predict_opmd"> </td>
          <td class="text-center" id = "patient_and_osm_patient_ai_predict_oscc"> </td>
          <td class="text-center" id = "patient_and_osm_patient_ai_predict_normal"></td>

          <td class="text-center" id = "patient_and_osm_patient_dentist_diagnose_opmd"></td>
          <td class="text-center" id = "patient_and_osm_patient_dentist_diagnose_oscc"></td>
          <td class="text-center" id = "patient_and_osm_patient_dentist_diagnose_normal"></td>
          <td class="text-center" id = "patient_and_osm_patient_dentist_diagnose_poor_image"></td>
          <td class="text-center" id = "patient_and_osm_patient_dentist_diagnose_others"></td>
          <td class="text-center" id = "patient_and_osm_patient_accuracy"></td>
          <td class="text-center" id = "patient_and_osm_patient_dentist_diagnose_not_diagnosed"></td>
        </tr>
        <tr id="osm">
          <td>อสม.</td>
          <td class="text-center" id ="patient_and_osm_osm_total_pic"></td>
          <td class="text-center" id = "patient_and_osm_osm_ai_predict_opmd"> </td>
          <td class="text-center" id = "patient_and_osm_osm_ai_predict_oscc"> </td>
          <td class="text-center" id = "patient_and_osm_osm_ai_predict_normal"></td>

          <td class="text-center" id = "patient_and_osm_osm_dentist_diagnose_opmd"></td>
          <td class="text-center" id = "patient_and_osm_osm_dentist_diagnose_oscc"></td>
          <td class="text-center" id = "patient_and_osm_osm_dentist_diagnose_normal"></td>
          <td class="text-center" id = "patient_and_osm_osm_dentist_diagnose_poor_image"></td>
          <td class="text-center" id = "patient_and_osm_osm_dentist_diagnose_others"></td>
          <td class="text-center" id = "patient_and_osm_osm_accuracy"></td>
          <td class="text-center" id = "patient_and_osm_osm_dentist_diagnose_not_diagnosed"></td>
        </tr>
        <tr id="total">
          <td>รวม</td>
          <td class="text-center" id = "patient_and_osm_total_total_pic"></td>
          <td class="text-center" id = "patient_and_osm_total_ai_predict_opmd"></td>
          <td class="text-center" id = "patient_and_osm_total_ai_predict_oscc"></td>
          <td class="text-center" id = "patient_and_osm_total_ai_predict_normal"></td>
          <td class="text-center" id = "patient_and_osm_total_dentist_diagnose_opmd"></td>
          <td class="text-center" id = "patient_and_osm_total_dentist_diagnose_oscc"></td>
          <td class="text-center" id = "patient_and_osm_total_dentist_diagnose_normal"></td>
          <td class="text-center" id = "patient_and_osm_total_dentist_diagnose_poor_image"></td>
          <td class="text-center" id = "patient_and_osm_total_dentist_diagnose_others"></td>
          <td class="text-center" id = "patient_and_osm_total_accuracy"></td>
          <td class="text-center" id = "patient_and_osm_total_dentist_diagnose_not_diagnosed"></td>
        </tr>
      </tbody>
    </table>
  </div>
  <br>
</div>
  <div class="card p-3 m-3" id="card">
    <h5 class="card-title">ตารางสรุปการนำส่งของบุคลากรทางการแพทย์</h5>
    <br>
    <div class="table-responsive">
      <table id="patientHistTable" class="table table-bordered" >
        <thead>
          <tr class="text-dark" style="width: 100%;">
            <th rowspan="2" class="align-middle" style="width: 10%;">ผู้นำส่ง</th>
            <th rowspan="2" class="align-middle text-center" style="width: 10%;">จำนวนภาพ</th>
            <th colspan="3" class="text-center" style="width: 30%;">ผลคำวินิจฉัยโดย AI</th>
            <th colspan="7" class="text-center" style="width: 50%;">ความคิดเห็นต่อผลการวินิจฉัยของ AI</th>
          </tr>
          <tr>
            <th class="text-center align-middle">OPMD</th>
            <th class="text-center align-middle">OSCC</th>
            <th class="text-center align-middle">NORMAL</th>
  
            <th class="text-center align-middle" style="width: 30%;">Agree</th>
            <th class="text-center align-middle" style="width: 30%;">Dissagree</th>

          </tr>
        </thead>
        <tbody id="specialistTable">
        </tbody>
      </table>
    </div>
    <br>
    <div class="table-responsive">
      <table id="summaryTable" class="table table-bordered" >
        <thead>
          <tr class="text-dark" style="width: 100%;">
            <th rowspan="2" style="width: 40%;" class="align-middle">สรุปจำนวนรูปทั้งหมด ที่นำส่งโดยประชาชนทั่วไปและทันตบุคลากร</th>
            <th rowspan="2" style="width: 20%;" class="align-middle text-center">จำนวนภาพ</th>
            <th colspan="3" style="width: 40%;" class="text-center">ผลคำวินิจฉัยโดย AI</th>
          </tr>
          <tr>
            <th class="text-center">OPMD</th>
            <th class="text-center">OSCC</th>
            <th class="text-center">NORMAL</th>
          </tr>
        </thead>
        <tbody> 
          <tr>
            <td>รวม</td>
            <td class="text-center" id = "total_pic"></td>
            <td class="text-center" id = "total_pic_ai_predict_opmd"></td>
            <td class="text-center" id = "total_pic_ai_predict_oscc"></td>
            <td class="text-center" id = "total_pic_ai_predict_normal"></td>
          </tr>
        </tbody>
      </table>
    </div>
{% endblock %}